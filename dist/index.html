<!DOCTYPE html>
<html lang="en">

<head>
  <style>
    html {
      visibility: hidden;
      opacity: 0;
    }
  </style>
  <meta charset="utf-8" />
  <title>flure playground</title>
  <meta name="description" content="flure" />
  <meta name="author" content="karnpapon boonput" />
  <link rel="icon" type="image/png" href="public/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="fengari-web.js" type="text/javascript"></script>
  <script src="bundle.js"></script>
</head>

<body>
  <script type="text/javascript">
    window.onload = function () {
      renderWelcomeCanvas();
      initScalerX()
      initScalerY()
      initBinaryCanvas();
      initNavCanvas();

      let output = document.getElementById("flure-console");

      function save() {
        if (!window.flure_value) return false;
        const bb = new Blob([window.flure_value], { type: "text/plain" });
        const a = document.createElement("a");
        a.download = "flure_image.pbm";
        a.href = window.URL.createObjectURL(bb);
        a.click();
      }

      output.addEventListener("flure_image_result_starting", function () {
        // let loading_elem = document.getElementById("canvas_loading");
        // loading_elem.style.display = "block";
      });

      output.addEventListener("flure_image_result_processing", function (e) {
        let canvas = document.getElementById("flure_canvas");
        let binary_canvas = document.getElementById("flure_binary_display");
        let flure_canvas_nav = document.getElementById("flure_canvas_nav");
        if (!window.flure_value) return false;
        pbm2canvas(window.flure_value, canvas, binary_canvas, flure_canvas_nav, e.detail);
      });

      output.addEventListener("flure_image_result_end", function () {
        // let loading_elem = document.getElementById("canvas_loading");
        // loading_elem.style.display = "none";
        let save_btn = document.getElementById("save-btn");
        save_btn.removeEventListener("click", save);
        save_btn.disabled = false;
        save_btn.style.backgroundColor = "white";
        save_btn.addEventListener("click", () => save());
      });
    };

    function renderWelcomeCanvas() {
      let width = 800;
      let height = 800;
      let canvas = document.getElementById("flure_canvas");
      let ctx = canvas.getContext("2d");
      let x_pos = 0

      canvas.height = height;
      canvas.width = width;
      ctx.font = "20px monospace";
      ctx.fillText("flure playground", x_pos, 50);

      ctx.font = "14px monospace";
      ctx.fillText(
        'a playground for "flure", a stack-based programming language',
        x_pos,
        30 * 3
      );
      ctx.fillText("to create binary graphic (1-bit).", x_pos, 30 * 4);
      ctx.fillText("inspired by FORTH language.", x_pos, 30 * 5);     
    }

    function initScalerY(){
      let height = 800;
      let canvas_scaler = document.getElementById("flure_canvas_scaler");
      let ctx_scaler = canvas_scaler.getContext("2d");
      let scale_nav_x_offset = 15 
      let flure_size = 128
      let canvas_scaler_h = height - 10
      let scale_nav_x_pixel_offset = canvas_scaler_h / flure_size 
      canvas_scaler.height = canvas_scaler_h + 10;
      canvas_scaler.width = 30;

      ctx_scaler.fillStyle = "rgb(100,100,100)";
      ctx_scaler.lineWidth = 0.25;
      ctx_scaler.beginPath();
      ctx_scaler.moveTo(scale_nav_x_offset, 5);
      ctx_scaler.lineTo(scale_nav_x_offset + 10, 5);
      ctx_scaler.moveTo(scale_nav_x_offset + 10, 5);
      ctx_scaler.lineTo(scale_nav_x_offset + 10, canvas_scaler_h);
      ctx_scaler.fillColor = ""
      ctx_scaler.font = "8px monospace";
      Array.from(Array(128)).map(( num, i ) => {
        if (i % 5 === 0) {
          ctx_scaler.fillText(i, scale_nav_x_offset - 10, (scale_nav_x_pixel_offset * i) ); 
          ctx_scaler.moveTo(scale_nav_x_offset + 5, 5 + (scale_nav_x_pixel_offset * i));
        }
        // ctx_scaler.moveTo(scale_nav_x_offset + (i % 5 == 0 ? 0 : 5), 5 + (scale_nav_x_pixel_offset * i));
        ctx_scaler.lineTo(scale_nav_x_offset + 10, 5 + (scale_nav_x_pixel_offset * i) );
      })

      ctx_scaler.moveTo(scale_nav_x_offset + 10, canvas_scaler_h);
      ctx_scaler.lineTo(scale_nav_x_offset, canvas_scaler_h);
      ctx_scaler.stroke();
    }

    function initScalerX(){
      let width = 800
      let height = 30;
      let canvas_scaler = document.getElementById("flure_canvas_scaler_x");
      let ctx_scaler = canvas_scaler.getContext("2d");
      let scale_nav_x_offset = 15 
      let flure_size = 128
      let canvas_scaler_h = height - 10
      let scale_nav_x_pixel_offset = width / flure_size 
      let off_x = 5
      canvas_scaler.height = canvas_scaler_h + 10;
      canvas_scaler.width = width;

      ctx_scaler.fillStyle = "rgb(100,100,100)";
      ctx_scaler.lineWidth = 0.25;
      ctx_scaler.beginPath();
      ctx_scaler.moveTo(off_x, 0 + 10);
      ctx_scaler.lineTo(off_x, 0);
      ctx_scaler.moveTo(off_x, 0);
      ctx_scaler.lineTo(width, 0);
      ctx_scaler.fillColor = ""
      ctx_scaler.font = "8px monospace";
      Array.from(Array(128)).map(( num, i ) => {
        if (i % 5 === 0) {
          ctx_scaler.fillText(i, (scale_nav_x_pixel_offset * i)+10, scale_nav_x_offset-off_x ); 
          ctx_scaler.moveTo(off_x + (scale_nav_x_pixel_offset * i), 0 );
          ctx_scaler.lineTo(off_x + (scale_nav_x_pixel_offset * i), 0 + 10 );
        }
      })

      ctx_scaler.moveTo(width, 0);
      ctx_scaler.lineTo(width, 0+10);
      ctx_scaler.stroke();
    }

    function initNavCanvas() {
      let width = 40;
      let height = 800;
      let canvas = document.getElementById("flure_canvas_nav");
      let ctx = canvas.getContext("2d");

      canvas.height = height;
      canvas.width = width;
      ctx.fillStyle = "rgb(100,100,100)";
      ctx.font = "10px monospace";
      ctx.fillText("y:0", 0, 40);
    }

    function initBinaryCanvas() {
      let width = 545 * 1.5;
      let height = 540 * 1.5;
      let canvas = document.getElementById("flure_binary_display");
      let ctx = canvas.getContext("2d");

      canvas.height = height;
      canvas.width = width;
      ctx.fillStyle = "rgb(100,100,100)";
      ctx.font = "10px monospace";
      for (i = 0; i < 256; i++) {
        ctx.fillText("0".repeat(136), 0, 10 * i);
      }
    }
  </script>

  <div class="h-screen p-10 bg-white dark:bg-gray-900 antialiased flex-col">
    <div class="flex h-full justify-center">
      <div class="relative flex flex-col h-full w-[56%]">
        <canvas id="flure_canvas_scaler_x" class=" w-[calc(100%_-_10px)] h-[30px]"></canvas>
        <div class="relative flex justify-center items-center h-full rounded-xl overflow-hidden ">
          <div class="relative w-full h-full object-contain object-center rounded-xl overflow-hidden">
            <div class="absolute left-0 bottom-0 z-[99] mb-2 ml-3">
              <button id="save-btn" type="button" disabled
                class="inset-0 py-2 px-2 text-xs font-medium focus:outline-none bg-gray-100 text-gray-400 hover:bg-gray-200 rounded-lg border border-gray-200 focus:z-10 focus:ring-4 focus:ring-gray-200">
                <img src="public/download.png" class="w-4 h-4" alt="save image (.pbm)" />
              </button>
            </div>
            <canvas id="flure_canvas" class="absolute z-10 rounded-xl h-full w-[calc(100%_-_10px)]" />
            <!-- <canvas id="flure_canvas" class="absolute z-10 rounded-xl h-full top-1/2 right-1/2 translate-x-1/2 -translate-y-1/2" /> -->
          </div>
        </div>
      </div>
      <canvas id="flure_canvas_scaler" class="w-[30px] h-[755px] mt-auto"></canvas>
      <canvas id="flure_canvas_nav" class="w-[40px] mr-2 ml-2"></canvas>
      <div class="flex flex-col ">
        <div class="flex flex-1">
          <div class="flex w-[545px] h-[540px] overflow-hidden rounded-lg mb-4 p-2 bg-gray-100">
            <canvas id="flure_binary_display" />
          </div>
        </div>

        <div
          class="repl bg-gray-100 border border-gray-100 w-full p-2 text-xs text-gray-600 rounded-md flex flex-col h-[200px] hover:border hover:border-gray-400">
          <code id="flure-console"></code>
          <div class="flure-input-container self-end w-full">
            <label id="flure-prompt" for="flure-input">&gt;</label>
            <textarea class="w-full" id="flure-input" rows="1" autofocus
              placeholder="try here, for quick tutorial: `x y ^ 5 % !` then ShiftEnter"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="pbm2canvas.js" type="text/javascript"></script>
  <script src="lua/web-cli.lua" type="application/lua" async></script>
</body>

</html>