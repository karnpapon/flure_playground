<!DOCTYPE html>
<html data-mode="light" lang="en">

<head>
  <style>
    html {
      visibility: hidden;
      opacity: 0;
    }
  </style>
  <meta charset="utf-8" />
  <title>flure playground</title>
  <meta name="description" content="flure" />
  <meta name="author" content="karnpapon boonput" />
  <link rel="icon" type="image/png" href="public/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="fengari-web.js" type="text/javascript"></script>
  <script src="bundle.js"></script>
</head>

<body>
  <script type="text/javascript">
    window.theme = "light"
    window.onload = function () {
      let output = document.getElementById("flure-console");

      initScalerX()
      initScalerY()
      initBinaryCanvas();
      // initNavCanvas();

      document.onkeydown = function(evt) {
        evt = evt || window.event;
        let isEscape = false;
        if ("key" in evt) {
          isEscape = (evt.key === "Escape" || evt.key === "Esc");
        } else {
          isEscape = (evt.keyCode === 27);
        }
        if (isEscape) {
          clearScreen()
        }
      };

      output.addEventListener("flure_image_result_starting", function () {
        let flure_welcome_msg = document.getElementById("flure_welcome_msg");
        let flure_canvas = document.getElementById("flure_canvas"); 
        flure_canvas.style.display = "block";
        flure_welcome_msg.style.display = "none";
      });

      output.addEventListener("flure_image_result_processing", function (e) {
        let canvas = document.getElementById("flure_canvas");
        let binary_canvas = document.getElementById("flure_binary_display");
        // let flure_canvas_nav = document.getElementById("flure_canvas_nav");
        if (!window.flure_value) return false;
        pbm2canvas(window.flure_value, canvas, binary_canvas, e.detail);
      });

      output.addEventListener("flure_image_result_end", function () {
        let save_btn = document.getElementById("save-btn");
        save_btn.removeEventListener("click", save);
        save_btn.disabled = false;
        save_btn.addEventListener("click", () => save());
      }); 

      const params = new Proxy(new URLSearchParams(window.location.search), {
        get: (searchParams, prop) => searchParams.get(prop),
      });

      if (params.theme) {
        window.theme = params.theme
        let html = document.querySelector('[data-mode]')
        html.setAttribute("data-mode", params.theme)
      }
    };

    function save() {
      if (!window.flure_value) return false;
      const bb = new Blob([window.flure_value], { type: "text/plain" });
      const a = document.createElement("a");
      a.download = "flure_image.pbm";
      a.href = window.URL.createObjectURL(bb);
      a.click();
    }

    function clearScreen(){
      let flure_welcome_msg = document.getElementById("flure_welcome_msg");
      let flure_canvas = document.getElementById("flure_canvas");
      flure_canvas.style.display = "none";
      flure_welcome_msg.style.display = "flex";
      window.flure_value = ""
      clearBinaryCanvas()
    }

    function initScalerY(){
      let canvas_scaler = document.getElementById("flure_canvas_scaler");
      let height = canvas_scaler.clientHeight;
      let ctx_scaler = canvas_scaler.getContext("2d");
      let scale_nav_x_offset = 15 
      let flure_size = 128
      let canvas_scaler_h = height - 10
      let scale_nav_x_pixel_offset = (canvas_scaler_h - 20) / flure_size 
      canvas_scaler.height = canvas_scaler_h + 30;
      canvas_scaler.width = 32;
      
      ctx_scaler.strokeStyle = window.theme === "dark" ? "white" : "rgb(100,100,100)";
      ctx_scaler.lineWidth = window.theme === "dark" ? 0.25 : 0.25;
      ctx_scaler.beginPath();
      ctx_scaler.moveTo(scale_nav_x_offset, 5);
      ctx_scaler.lineTo(scale_nav_x_offset + 10, 5);
      ctx_scaler.moveTo(scale_nav_x_offset + 10, 5);
      ctx_scaler.lineTo(scale_nav_x_offset + 10, canvas_scaler_h);

      ctx_scaler.moveTo(scale_nav_x_offset + 10, canvas_scaler_h);
      ctx_scaler.lineTo(scale_nav_x_offset, canvas_scaler_h);
      ctx_scaler.stroke();

      ctx_scaler.fillStyle = window.theme === "dark" ? "white" : "rgb(100,100,100)";
      ctx_scaler.save();
      ctx_scaler.rotate(-Math.PI/2);
      ctx_scaler.textAlign = "center";
      ctx_scaler.font = "10px monospace";
      ctx_scaler.fillText("(127,0)", -30, 20 ); 
      ctx_scaler.fillText("(127,127)", -height + 42, 20 ); 
      ctx_scaler.restore();
    }

    function initScalerX(){
      let width = 800
      let height = 30;
      let canvas_scaler = document.getElementById("flure_canvas_scaler_x");
      let ctx_scaler = canvas_scaler.getContext("2d");
      let scale_nav_x_offset = 15 
      let flure_size = 128
      let canvas_scaler_h = height - 10
      let scale_nav_x_pixel_offset = width / flure_size 
      let off_x = 5
      canvas_scaler.height = canvas_scaler_h + 10;
      canvas_scaler.width = width;

      ctx_scaler.strokeStyle = window.theme === "dark" ? "white" : "rgb(100,100,100)";
      ctx_scaler.lineWidth = window.theme === "dark" ? 0.25 : 0.25;
      ctx_scaler.beginPath();
      ctx_scaler.moveTo(off_x, 0 + 10);
      ctx_scaler.lineTo(off_x, 0);
      ctx_scaler.moveTo(off_x, 0);
      ctx_scaler.lineTo(width, 0);

      ctx_scaler.moveTo(width, 0);
      ctx_scaler.lineTo(width, 0+10);
      ctx_scaler.stroke();

      ctx_scaler.fillStyle = window.theme === "dark" ? "white" : "rgb(100,100,100)";
      ctx_scaler.font = "10px monospace";
      ctx_scaler.fillText("(0,0)", (scale_nav_x_pixel_offset), scale_nav_x_offset-off_x ); 
      ctx_scaler.fillText("(127,0)", (scale_nav_x_pixel_offset) + (width - 55), scale_nav_x_offset-off_x ); 
    }

    function clearBinaryCanvas() {
      let canvas = document.getElementById("flure_binary_display");
      let ctx = canvas.getContext("2d");
      let width = canvas.clientWidth * 1.7 ;
      let height = canvas.clientHeight * 1.7 ;
      canvas.height = height;
      canvas.width = width;
      ctx.scale(1.5,1.5)
      ctx.fillStyle = "rgb(100,100,100)";
      ctx.font = "10px monospace";
      for (i = 0; i < 128; i++) {
        ctx.fillText("0".repeat(canvas.clientWidth / 2), 0, 10 * i);
      }
    }

    function initBinaryCanvas() {
      let canvas = document.getElementById("flure_binary_display");
      let ctx = canvas.getContext("2d");
      let width = canvas.clientWidth * 2 ;
      let height = canvas.clientHeight * 4 ;
      canvas.height = height-(canvas.clientHeight / 2);
      canvas.width = width;
      ctx.scale(1.25,1.25)
      ctx.fillStyle = "rgb(100,100,100)";
      ctx.font = "10px monospace";
      for (i = 0; i < 128; i++) {
        ctx.fillText("0".repeat(canvas.clientWidth / 2), 0, 10 * i);
      }
    }
  </script>

  <div class="h-screen p-10 bg-white dark:bg-black  antialiased flex-col">
    <div class="flex  h-full justify-center">
      <div class="relative flex flex-col h-full w-[56%]">
        <canvas id="flure_canvas_scaler_x" class=" w-[calc(100%_-_10px)] h-[30px]"></canvas>
        <div class="relative flex justify-center items-center h-full rounded-xl overflow-hidden">
          <div class="relative w-full h-full object-contain object-center rounded-xl overflow-hidden">
            <div id="flure_welcome_msg" class="flex flex-col pl-2 pt-2 h-full justify-between text-sm text-gray-600 dark:text-white font-mono">
              <div class="">
                <!-- <p class="text-2xl mb-5 font-bold">flure playground</p> -->
                <p>a playground for "flure", a stack-based programming language</p>
                <p>to create binary graphic (1-bit), inspired by FORTH language.</p>
              </div>

              <div class="flex flex-col text-xs pt-8">
                <h1 class="font-bold">Quickstart</h1>
                <li>copy, <code>x y ^ 5 % !</code>to the console (right handside) then Shift+Enter</li>
                <li>to clear a screen just hit <code>Esc</code></li>
                <br/>
                <h1 class="font-bold">Guides</h1>
                <p><code>flure</code> use reverse polish notation (RPN) eg <code>10 10 +</code> will return <code>20</code></p>
                <li><code>x</code> and <code>y</code> correspond to x,y coordinates</li>
                <li>arithmatics = <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code></li>
                <li>bitwise = <code>&</code>, <code>|</code>, <code>^</code>, <code>&lt;&lt;</code>, <code>&gt;&gt;</code></li>
                <li>stack = <code>pop</code>, <code>push</code>, <code>show</code></li>
                <li>function declaration (or <code>word</code> in <code>FORTH</code>'s term)<code>: <function_name> &lt;...args&gt;;</code> eg. <code> : loop 1 - dup 0 = if else loop then ; </code></li>
                  <li>compile mode = <code>:</code>, delimited compile mode = <code>;</code></li>
                  <li>basic control flow <code>&lt;case&gt; if &lt;if_case&gt; else &lt;else_case&gt; then ;</code></li>
                  <li>comments = <code>( &lt;...comments&gt; )</code></li>
                  <li><code>immediate</code>ly call a function = eg. <code> : bob 20 20 + ; immediate</code>, will return <code>40</code> without calling <code>bob</code></li>
                  <li>core = (<code>-1</code> =  <code>true</code>, <code>0</code> = <code>false</code>)</li>
                  <div class="ml-4">
                    <li><code>=</code>(equal) , <code>&lt;&gt;</code></code>(not equal)</li>
                    <li><code>and</code> , <code>or</code> , <code>&gt;</code>(greater_than), <code>&lt;</code>(less_than)</li>
                    <li><code>dup</code>(duplicate) , <code>2dup</code>(double duplicate) , <code>swap</code> , <code>rot</code>(rotate)</li>
                    <li><code>abs</code>(absolute number)</li>
                    <li><code>%</code>(modulo), <code>!</code>(cast to 0 or 1)</li>
                  </div>
                  <li>to exit = <code>bye</code></li>
    
                <br/>
                <h1 class="font-bold">Examples</h1>
                <p>each line below will computes a different results</p>
                <p>
                  <b>[note] current computed image size = <code>128px * 128px</code></b>
                  (these number (<code>128</code> and <code>128</code>) can be substituted by <code>w</code> and <code>h</code>).
                </p>
                <br/>
                <li><code>x y ^ 5 % !</code></li>
                <li><code>x y + abs x y - abs 1 + ^ 2 &lt;&lt; 5 % !</code></li>
                <li><code>x 2 * y % !</code></li>
                <li><code>x w 2 / - w 4 / * y w 2 / - % !</code></li>
              </div>

              <div class="w-full flex space-x-6 mt-auto">
                <span class="text-xs  text-gray-500 dark:text-gray-300 sm:text-center">MIT License, 2023, Bangkok Thailand  <a target="_blank" class="underline" href="https://github.com/karnpapon/flure">https://github.com/karnpapon/flure</a></span>
              </div>
            </div>
            <canvas id="flure_canvas" class="absolute z-10 rounded-lg h-full w-[calc(100%_-_10px)] object-cover  dark:bg-black" />
          </div>
        </div>
      </div>
      <div class="mr-4"> 
        <div class="-translate-y-1 flex text-xs flex-col justify-between text-gray-500 dark:text-white whitespace-nowrap font-mono font-bold">
          <p>x </p>
          <p>&nbsp; y </p>
        </div>
        <canvas id="flure_canvas_scaler" class="w-[30px] h-full mt-auto"></canvas>
      </div>
      <div class="flex flex-col">
        <div class="flex flex-1 flex-col ">
          <div class="flex w-full max-w-[545px] max-h-[460px] overflow-hidden rounded-lg rounded-b-none p-2 pb-0 bg-gray-100 dark:bg-black border border-gray-100 dark:border-gray-600">
            <canvas id="flure_binary_display"  class="w-full h-full"/>
          </div>
          <div class="flex w-full justify-center items-center p-2 bg-gray-100 dark:bg-black  mb-2 rounded-lg  rounded-t-none z-0 border border-t-none border-gray-100 dark:border-gray-600">
            <div class="">
              <button id="save-btn" type="button" alt="save image (.pbm)" disabled
                class="text-xs cursor-pointer font-medium mr-2 focus:outline-none text-gray-400 rounded-lg  focus:z-10 focus:ring-4 focus:ring-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="save-btn" width="20" height="20" viewBox="0 0 20 20">
                  <path d="M17 12v5H3v-5H1v5a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-5z"/>
                  <path d="M10 15l5-6h-4V1H9v8H5l5 6z"/>
                </svg>

              </button>
            </div>
            <p class="text-xs text-gray-400 dark:text-white font-mono">.pbm (portable bitmap file format): 128px * 128px</p>
            <!-- <p class="text-xs p-2 text-gray-400">x y | y x * x & %</p> -->
           </div>
        </div>

        <div
          class="repl bg-gray-100 dark:bg-black border border-gray-100 dark:border-gray-600 w-full p-2 text-xs text-gray-600 rounded-md flex flex-col h-full max-h-[260px] hover:border hover:border-gray-400">
          <code id="flure-console"></code>
          <div class="flure-input-container self-end w-full">
            <label class="dark:text-white" id="flure-prompt" for="flure-input">&gt;</label>
            <textarea class="w-full dark:text-white" id="flure-input" rows="1" autofocus
              placeholder="try: `x y ^ 5 % !` + ShiftEnter, clear a screen = `Esc`"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="pbm2canvas.js" type="text/javascript"></script>
  <script src="lua/web-cli.lua" type="application/lua" async></script>
</body>

</html>